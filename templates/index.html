<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forest Species Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/cirrus-ui@0.7.1/dist/cirrus.min.css">
    <script src="https://kit.fontawesome.com/8ee0b8559b.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:200,300,400,600,700" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.js"></script>
    <style>
            /* Ambient Background with Gradient Lights */
            body {
                background: #1a1a1a;
                background-image:
                    radial-gradient(circle at 20% 80%, rgba(255, 51, 126, 0.05) 0%, transparent 50%),
                    radial-gradient(circle at 80% 20%, rgba(193, 204, 49, 0.04) 0%, transparent 50%),
                    radial-gradient(circle at 40% 40%, rgba(255, 154, 97, 0.03) 0%, transparent 50%),
                    radial-gradient(circle at 90% 80%, rgba(255, 154, 97, 0.03) 0%, transparent 50%),
                    radial-gradient(circle at 10% 30%, rgba(193, 204, 49, 0.02) 0%, transparent 50%);
                min-height: 100vh;
                padding-top: 60px;
                color: #6330dc;
                position: relative;
                overflow-x: hidden;
            }

            body::before {
                content: '';
                position: fixed;
                top: 20%;
                left: 70%;
                width: 800px;
                height: 800px;
                background: radial-gradient(circle, rgba(255, 154, 97, 0.03) 20%,rgba(250, 182, 51, 0.05) 0%, rgba(250, 182, 51, 0.05) 12%, transparent 50%),
                            radial-gradient(circle at 80% 80%, rgba(193, 204, 49, 0.02) 0%, transparent 50%);;
                border-radius: 50%;
                animation: ambientMove ease-in-out infinite 30s;
                pointer-events: none;
                z-index: -1;
                filter: blur(40px);
            }

            body::after {
                content: '';
                position: fixed;
                top: 60%;
                left: 10%;
                width: 600px;
                height: 600px;
                background: radial-gradient(circle, rgba(155, 89, 182, 0.1) 0%, rgba(155, 89, 182, 0.03) 40%, transparent 70%);
                animation: ambientMove ease-in-out infinite 30s;
                border-radius: 50%;
                pointer-events: none;
                z-index: -1;
                filter: blur(30px);
            }

            @keyframes ambientMove {
                0%, 100% { transform: translate(0, 0) rotate(0deg); }
                33% { transform: translate(-20px, -30px) rotate(120deg); }
                66% { transform: translate(20px, 30px) rotate(240deg); }
            }


            /* Enhanced Upload Card with Ambient Glow */
            .upload-card {
                max-width: 500px;
                width: 100%;
                padding: 25px;
                background: linear-gradient(135deg, rgba(45, 45, 45, 0.9), rgba(35, 35, 35, 0.8));
                backdrop-filter: blur(20px);
                border-radius: 16px;
                box-shadow:
                    0 8px 32px rgba(0, 0, 0, 0.4),
                    0 0 0 1px rgba(250, 182, 51, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.05);
                margin: 20px 0;
                position: relative;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                overflow: hidden;
            }

            .upload-card::before {
                content: '';
                position: absolute;
                top: -2px;
                left: -2px;
                right: -2px;
                bottom: -2px;
                background: linear-gradient(45deg, rgba(250, 182, 51, 0.1), rgba(250, 182, 51, 0.15), rgba(250, 182, 51, 0.1));
                border-radius: 16px;
                z-index: -1;
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .upload-card:hover {
                transform: translateY(-5px);
                box-shadow:
                    0 20px 40px rgba(0, 0, 0, 0.5),
                    0 0 0 1px rgba(250, 182, 51, 0.2),
                    0 0 30px rgba(250, 182, 51, 0.1);
            }

            .upload-card:hover::before {
                opacity: 1;
            }

            .upload-card h2 {
                color: #e0e0e0;
                font-weight: 700;
                font-size: 1.5rem;
                margin-bottom: 20px;
                background: linear-gradient(135deg, #e0e0e0, #cbd5e0);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            /* Enhanced Drop Zone with Ambient Effects */
            .drop-zone {
                border: 2px dashed rgba(74, 74, 74, 0.8);
                border-radius: 12px;
                padding: 2.5rem;
                text-align: center;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                background: linear-gradient(135deg, rgba(45, 45, 45, 0.3), rgba(35, 35, 35, 0.2));
                backdrop-filter: blur(10px);
                position: relative;
                overflow: hidden;
            }

            .drop-zone::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(250, 182, 51, 0.1), transparent);
                transition: left 0.5s ease;
            }

            .drop-zone:hover::before {
                left: 100%;
            }

            .drop-zone:hover {
                border-color: rgba(250, 182, 51, 0.6);
                background: linear-gradient(135deg, rgba(250, 182, 51, 0.05), rgba(35, 35, 35, 0.3));
                box-shadow:
                    0 0 30px rgba(250, 182, 51, 0.2),
                    inset 0 0 30px rgba(250, 182, 51, 0.05);
                transform: scale(1.02);
            }

            .drop-zone.dragover {
                border-color: #fab633;
                background: linear-gradient(135deg, rgba(250, 182, 51, 0.1), rgba(35, 35, 35, 0.4));
                box-shadow: 0 0 40px rgba(250, 182, 51, 0.3);
                transform: scale(1.05);
            }

            .drop-zone p {
                margin-top: 1rem;
                color: #a0a0a0;
                transition: color 0.3s ease;
            }

            .drop-zone:hover p {
                color: #cbd5e0;
            }

            /* Enhanced Buttons with Glow Effects */
            .btn-upload {
                margin-bottom: 1rem;
                background: linear-gradient(135deg, #fab633, #f39c12);
                color: #1a1a1a;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-weight: 600;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow:
                    0 4px 15px rgba(250, 182, 51, 0.3),
                    0 0 0 1px rgba(250, 182, 51, 0.2);
                position: relative;
                overflow: hidden;
            }

            .btn-upload::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                transition: left 0.5s ease;
            }

            .btn-upload:hover {
                transform: translateY(-2px);
                background: linear-gradient(135deg, #fbb01f, #fab633);
                box-shadow:
                    0 8px 25px rgba(250, 182, 51, 0.4),
                    0 0 30px rgba(250, 182, 51, 0.3);
            }

            .btn-upload:hover::before {
                left: 100%;
            }

            /* Enhanced Map Container */
            #map {
                width: 100%;
                height: 600px;
                margin: 20px 0;
                border: none;
                background-color: #1a1a2a !important;
                border-radius: 16px;
                overflow: hidden;
                box-shadow:
                    0 8px 32px rgba(0, 0, 0, 0.4),
                    0 0 0 1px rgba(250, 182, 51, 0.1);
                transition: all 0.3s ease;
            }

            #map:hover {
                box-shadow:
                    0 12px 40px rgba(0, 0, 0, 0.5),
                    0 0 0 1px rgba(250, 182, 51, 0.2),
                    0 0 30px rgba(250, 182, 51, 0.1);
            }

            .container {
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
                max-width: 1200px;
                margin: 0 auto;
                padding: 0 20px;
                position: relative;
            }

            /* Enhanced Warning Box */
            .upload-warning {
                box-shadow:
                    0 8px 32px rgba(250, 182, 51, 0.3),
                    0 0 0 1px rgba(250, 182, 51, 0.2);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .warning-hover {
                transform: scale(1);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                background: linear-gradient(135deg, #3498db, #2980b9) !important;
                position: relative;
                overflow: hidden;
            }

            .warning-hover::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
                transition: left 0.5s ease;
            }

            .warning-hover:hover {
                transform: scale(1.05);
                background: linear-gradient(135deg, #5dade2, #3498db) !important;
                box-shadow:
                    0 12px 40px rgba(250, 182, 51, 0.4),
                    0 0 40px rgba(250, 182, 51, 0.3);
                cursor: pointer;
            }

            .warning-hover:hover::before {
                left: 100%;
            }

            .warning-hover:hover .fas {
                transform: scale(1.1);
                transition: transform 0.3s ease;
            }

            .warning-hover .fas {
                transition: transform 0.3s ease;
            }

            /* Disabled States */
            .drop-zone.disabled {
                opacity: 0.5;
                cursor: not-allowed;
                border-color: #666;
                background: linear-gradient(135deg, rgba(60, 60, 60, 0.3), rgba(40, 40, 40, 0.2));
            }

            .btn-disabled {
                background: linear-gradient(135deg, #666, #555) !important;
                color: #999 !important;
                cursor: not-allowed !important;
                box-shadow: none !important;
            }

            .btn-disabled:hover {
                background: linear-gradient(135deg, #666, #555) !important;
                color: #999 !important;
                transform: none !important;
            }

            /* Typography Enhancement */
            .font {
                font-family: "Avenir Next", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                color: #e0e0e0;
                padding: 15px;
                margin-top: 4px;
                font-weight: 500;
                letter-spacing: 0.5px;
                transition: all 0.3s ease;
            }

            /* Enhanced Modal Styles */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(10px);
                z-index: 2000;
                display: none;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            }

            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }

            .modal-content {
                background: linear-gradient(135deg, rgba(45, 45, 45, 0.95), rgba(26, 26, 26, 0.9));
                backdrop-filter: blur(20px);
                border-radius: 20px;
                max-width: 900px;
                max-height: 90vh;
                width: 90%;
                overflow-y: auto;
                box-shadow:
                    0 25px 50px rgba(0, 0, 0, 0.6),
                    0 0 0 1px rgba(250, 182, 51, 0.2),
                    0 0 40px rgba(250, 182, 51, 0.1);
                border: 1px solid rgba(250, 182, 51, 0.3);
                position: relative;
                animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }

            @keyframes modalSlideIn {
                from {
                    opacity: 0;
                    transform: translateY(50px) scale(0.9);
                }
                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            .modal-header {
                background: linear-gradient(135deg, #fab633, #f39c12);
                padding: 20px;
                border-radius: 16px 16px 0 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            .modal-title {
                color: #1a1a1a;
                font-size: 24px;
                font-weight: 700;
                margin: 0;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .modal-body {
                padding: 30px;
                color: #e0e0e0;
            }

            .image-preview-item {
                background: linear-gradient(135deg, rgba(55, 55, 55, 0.9), rgba(35, 35, 35, 0.8));
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 20px;
                border: 1px solid rgba(250, 182, 51, 0.2);
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
            }

            .image-preview-item:hover {
                border-color: rgba(250, 182, 51, 0.5);
                box-shadow: 0 8px 25px rgba(250, 182, 51, 0.2);
                transform: translateY(-2px);
            }

            .image-preview-content {
                display: flex;
                gap: 20px;
                align-items: flex-start;
            }

            .image-preview {
                width: 120px;
                height: 120px;
                border-radius: 8px;
                object-fit: cover;
                border: 2px solid rgba(250, 182, 51, 0.3);
                transition: all 0.3s ease;
            }

            .image-preview:hover {
                border-color: rgba(250, 182, 51, 0.6);
                box-shadow: 0 4px 15px rgba(250, 182, 51, 0.2);
            }

            .image-form-fields {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            .form-group {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }

            .form-label {
                color: #cbd5e0;
                font-weight: 600;
                font-size: 14px;
            }

            .form-input {
                background: rgba(45, 45, 45, 0.8);
                border: 1px solid rgba(250, 182, 51, 0.3);
                border-radius: 8px;
                padding: 12px;
                color: #e0e0e0;
                font-size: 14px;
                transition: all 0.3s ease;
            }

            .form-input:focus {
                outline: none;
                border-color: #fab633;
                box-shadow: 0 0 0 3px rgba(250, 182, 51, 0.1);
            }

            .form-select {
                background: rgba(45, 45, 45, 0.8);
                border: 1px solid rgba(250, 182, 51, 0.3);
                border-radius: 8px;
                padding: 12px;
                color: #e0e0e0;
                font-size: 14px;
                transition: all 0.3s ease;
            }

            .form-select:focus {
                outline: none;
                border-color: #fab633;
                box-shadow: 0 0 0 3px rgba(250, 182, 51, 0.1);
            }

            .icon-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
                gap: 10px;
                margin-top: 10px;
            }

            .icon-option {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 10px;
                border: 2px solid rgba(250, 182, 51, 0.3);
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s ease;
                background: rgba(45, 45, 45, 0.5);
                backdrop-filter: blur(5px);
            }

            .icon-option:hover {
                border-color: #fab633;
                background: rgba(250, 182, 51, 0.2);
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(250, 182, 51, 0.2);
            }

            .icon-option.selected {
                border-color: #fab633;
                background: rgba(250, 182, 51, 0.25);
                box-shadow: 0 0 15px rgba(250, 182, 51, 0.3);
            }

            .icon-option i {
                font-size: 24px;
                color: #fab633;
                margin-bottom: 5px;
                transition: all 0.3s ease;
            }

            .icon-option.selected i {
                color: #fab633;
                filter: drop-shadow(0 0 8px rgba(250, 182, 51, 0.5));
            }

            .icon-option span {
                font-size: 10px;
                color: #cbd5e0;
            }

            .location-info {
                background: rgba(45, 45, 45, 0.6);
                border-radius: 8px;
                padding: 15px;
                margin-top: 10px;
                border-left: 4px solid #fab633;
                backdrop-filter: blur(5px);
                transition: all 0.3s ease;
            }

            .location-warning {
                background: rgba(231, 76, 60, 0.2);
                border-left-color: #e74c3c;
                color: #ff6b6b;
            }

            .btn-location {
                background: linear-gradient(135deg, #fab633, #f39c12);
                color: #1a1a1a;
                border: none;
                padding: 8px 16px;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.3s ease;
                font-size: 12px;
                font-weight: 600;
            }

            .btn-location:hover {
                background: linear-gradient(135deg, #fbb01f, #fab633);
                transform: translateY(-1px);
                box-shadow: 0 4px 15px rgba(250, 182, 51, 0.3);
            }

            .modal-footer {
                padding: 20px 30px;
                background: rgba(35, 35, 35, 0.8);
                backdrop-filter: blur(10px);
                border-top: 1px solid rgba(250, 182, 51, 0.1);
                display: flex;
                justify-content: flex-end;
                gap: 15px;
                border-radius: 0 0 16px 16px;
            }

            .btn-modal {
                padding: 12px 24px;
                border-radius: 8px;
                border: none;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .btn-cancel {
                background: rgba(107, 114, 128, 0.8);
                color: #e0e0e0;
                border: 1px solid rgba(107, 114, 128, 0.3);
            }

            .btn-cancel:hover {
                background: rgba(107, 114, 128, 1);
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
            }

            .btn-upload-modal {
                background: linear-gradient(135deg, #fab633, #f39c12);
                color: #1a1a1a;
                box-shadow: 0 4px 15px rgba(250, 182, 51, 0.3);
            }

            .btn-upload-modal:hover {
                background: linear-gradient(135deg, #fbb01f, #fab633);
                transform: translateY(-1px);
                box-shadow: 0 8px 25px rgba(250, 182, 51, 0.4);
            }

            .btn-upload-modal:disabled {
                background: #666;
                color: #999;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }

            .location-modal-content {
                max-width: 700px;
            }

            #locationMap {
                width: 100%;
                height: 400px;
                border-radius: 8px;
                margin: 20px 0;
                border: 1px solid rgba(250, 182, 51, 0.2);
            }

            .coordinates-display {
                background: rgba(45, 45, 45, 0.8);
                backdrop-filter: blur(10px);
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 15px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border: 1px solid rgba(250, 182, 51, 0.2);
            }

            .coord-info {
                color: #cbd5e0;
            }

            .coord-values {
                font-family: 'Courier New', monospace;
                color: #fab633;
                font-weight: bold;
            }

            /* Enhanced Popup Styles */
            .custom-popup .leaflet-popup-content-wrapper {
                background: linear-gradient(135deg, rgba(45, 45, 45, 0.95), rgba(35, 35, 35, 0.9));
                backdrop-filter: blur(20px);
                color: #e0e0e0;
                font-family: 'Nunito Sans', sans-serif;
                font-size: 14px;
                padding: 16px;
                border-radius: 12px;
                box-shadow:
                    0 12px 30px rgba(0, 0, 0, 0.4),
                    0 0 0 1px rgba(250, 182, 51, 0.2),
                    0 0 20px rgba(250, 182, 51, 0.1);
                border: 1px solid rgba(250, 182, 51, 0.1);
            }

            .custom-popup .leaflet-popup-tip {
                background: linear-gradient(135deg, rgba(45, 45, 45, 0.95), rgba(35, 35, 35, 0.9));
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            }

            .quadrant-popup .leaflet-popup-content-wrapper {
                background: linear-gradient(135deg, rgba(45, 45, 45, 0.9), rgba(35, 35, 35, 0.8));
                backdrop-filter: blur(15px);
                color: #e0e0e0;
                font-family: 'Nunito Sans', sans-serif;
                font-size: 12px;
                padding: 10px;
                border-radius: 10px;
                box-shadow:
                    0 8px 25px rgba(0, 0, 0, 0.3),
                    0 0 0 1px rgba(250, 182, 51, 0.15);
            }

            .quadrant-popup .leaflet-popup-tip {
                background: linear-gradient(135deg, rgba(45, 45, 45, 0.9), rgba(35, 35, 35, 0.8));
            }

            /* Leaflet Control Enhancements */
            .leaflet-control-layers {
                z-index: 1;
                background: linear-gradient(135deg, rgba(33, 33, 33, 0.95), rgba(26, 26, 26, 0.9));
                backdrop-filter: blur(20px);
                color: #e0e0e0;
                border-radius: 10px;
                box-shadow:
                    0 8px 25px rgba(0, 0, 0, 0.3),
                    0 0 0 1px rgba(250, 182, 51, 0.1);
                border: 1px solid rgba(250, 182, 51, 0.1);
            }

            .leaflet-control-layers a {
                color: #e0e0e0;
                transition: color 0.3s ease;
            }

            .leaflet-control-layers a:hover {
                color: #fab633;
            }

            /* Loading States */
            .loading-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(5px);
                display: none;
                align-items: center;
                justify-content: center;
                border-radius: 20px;
            }

            .loading-spinner {
                width: 40px;
                height: 40px;
                border: 4px solid rgba(250, 182, 51, 0.3);
                border-top: 4px solid #fab633;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                filter: drop-shadow(0 0 10px rgba(250, 182, 51, 0.5));
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            /* Micro Interactions */
            * {
                transition: all 0.2s ease;
            }

            button, .btn, a {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            /* Glow Pulse Animation for Interactive Elements */
            @keyframes glowPulse {
                0%, 100% { box-shadow: 0 0 5px rgba(250, 182, 51, 0.2); }
                50% { box-shadow: 0 0 20px rgba(250, 182, 51, 0.4); }
            }

            .upload-card:hover {
                animation: glowPulse 3s ease-in-out infinite;
            }
            /* Upload and Analysis Layout - Enhanced */
            .upload-analysis-section {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 50px;
                width: 100%;
                max-width: 1200px;
                margin: 30px 0;
                flex-wrap: wrap;
            }

            .upload-side {
                flex: 1;
                max-width: 500px;
                min-width: 400px;
            }

            .analyze-side {
                flex: 1;
                max-width: 500px;
                min-width: 400px;
                display: flex;
                justify-content: center;
            }

            .flow-arrow {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 15px;
                flex-shrink: 0;
                padding: 20px;
            }

            .arrow-label {
                color: #fab633;
                font-weight: 700;
                font-size: 15px;
                text-transform: uppercase;
                letter-spacing: 2px;
                white-space: nowrap;
                text-shadow:
                    0 0 15px rgba(250, 182, 51, 0.4),
                    0 0 25px rgba(231, 76, 200, 0.6),
                    0 0 35px rgba(231, 76, 200, 0.4);
                background: linear-gradient(135deg, #fab633, #f39c12);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                transition: all 0.4s ease;
            }

            .arrow-label:hover {
                text-shadow:
                    0 0 20px rgba(250, 182, 51, 0.6),
                    0 0 35px rgba(231, 76, 200, 0.8),
                    0 0 50px rgba(231, 76, 200, 0.6),
                    0 0 70px rgba(231, 76, 200, 0.4);
                transform: scale(1.05);
            }

            .arrow-icon {
                font-size: 28px;
                color: #fab633;
                filter: drop-shadow(0 0 20px rgba(250, 182, 51, 0.6));
                transition: all 0.3s ease;
            }

            .arrow-icon:hover {
                transform: translateX(5px);
                filter: drop-shadow(0 0 25px rgba(250, 182, 51, 0.8));
            }

            .analyze-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 20px;
                padding: 30px;
                background: linear-gradient(135deg, rgba(45, 45, 45, 0.7), rgba(35, 35, 35, 0.5));
                backdrop-filter: blur(20px);
                border-radius: 20px;
                border: 1px solid rgba(250, 182, 51, 0.2);
                box-shadow:
                    0 8px 32px rgba(0, 0, 0, 0.3),
                    0 0 0 1px rgba(250, 182, 51, 0.1);
                transition: all 0.4s ease;
            }

            .analyze-container:hover {
                transform: translateY(-5px);
                border-color: rgba(250, 182, 51, 0.4);
                box-shadow:
                    0 20px 50px rgba(0, 0, 0, 0.4),
                    0 0 40px rgba(250, 182, 51, 0.2);
            }

            .btn-analyze {
                padding: 18px 36px;
                background: #fab633;
                color: #1a1a1a;
                border: none;
                border-radius: 14px;
                font-size: 16px;
                font-weight: 700;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 12px;
                text-transform: uppercase;
                letter-spacing: 1.5px;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow:
                    0 8px 25px rgba(250, 182, 51, 0.35),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
                position: relative;
                overflow: hidden;
            }

            .btn-analyze::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.25), transparent);
                transition: left 0.6s ease;
            }

            .btn-analyze:hover {
                transform: translateY(-3px) scale(1.02);
                background: #fbb01f;
                box-shadow:
                    0 15px 45px rgba(250, 182, 51, 0.5),
                    0 0 50px rgba(250, 182, 51, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }

            .btn-analyze:hover::before {
                left: 100%;
            }

            .btn-analyze:active {
                transform: translateY(-1px) scale(1.01);
                transition: all 0.1s ease;
            }

            .btn-analyze i {
                font-size: 18px;
                transition: all 0.3s ease;
            }

            .btn-analyze:hover i {
                transform: scale(1.1);
            }

            .analyze-description {
                color: #cbd5e0;
                font-size: 14px;
                text-align: center;
                max-width: 280px;
                line-height: 1.6;
                font-weight: 500;
                transition: all 0.3s ease;
            }

            .analyze-container:hover .analyze-description {
                color: #e0e0e0;
                text-shadow: 0 0 10px rgba(250, 182, 51, 0.2);
            }

            /* Responsive Design */
            @media (max-width: 768px) {
                .upload-analysis-section {
                    flex-direction: column;
                    gap: 40px;
                }

                .upload-side, .analyze-side {
                    min-width: auto;
                    width: 100%;
                    max-width: 500px;
                }

                .flow-arrow {
                    transform: rotate(90deg);
                    padding: 15px;
                }

                .arrow-label {
                    transform: rotate(-90deg);
                    font-size: 13px;
                }

                .analyze-container {
                    padding: 25px;
                }
            }
            /* Analysis Modal Styles - Simplified */
            .analysis-modal-content {
                max-width: 450px;
                background: linear-gradient(135deg, rgba(45, 45, 45, 0.95), rgba(26, 26, 26, 0.9));
            }

            .analysis-progress-container {
                text-align: center;
                padding: 40px 30px;
            }

            .progress-icon {
                margin-bottom: 30px;
            }

            .analysis-icon {
                font-size: 64px;
                color: #fab633;
                filter: drop-shadow(0 0 25px rgba(250, 182, 51, 0.6));
                transition: all 0.3s ease;
            }

            .progress-text {
                font-size: 20px;
                font-weight: 600;
                color: #e0e0e0;
                margin-bottom: 30px;
                min-height: 28px;
                text-shadow: 0 0 15px rgba(250, 182, 51, 0.3);
            }

            .progress-bar-container {
                width: 100%;
                height: 12px;
                background: rgba(45, 45, 45, 0.8);
                border-radius: 6px;
                overflow: hidden;
                margin-bottom: 20px;
                border: 1px solid rgba(250, 182, 51, 0.3);
                box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            }

            .progress-bar {
                height: 100%;
                background: linear-gradient(90deg, #fab633, #f39c12, #fab633);
                background-size: 200% 100%;
                border-radius: 6px;
                width: 0%;
                transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow:
                    0 0 20px rgba(250, 182, 51, 0.6),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
                position: relative;
            }

            .progress-bar::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
                background-size: 50% 100%;
                border-radius: 6px;
            }

            .progress-percentage {
                font-size: 28px;
                font-weight: 700;
                color: #fab633;
                text-shadow: 0 0 15px rgba(250, 182, 51, 0.5);
                margin-top: 10px;
            }
            /* Tip Box Styles */
            .tip-box {
                max-width: 1200px;
                width: 100%;
                padding: 15px 25px;
                background: linear-gradient(45deg, rgba(181, 122, 8, 0.05), rgba(250, 182, 51, 0.08), rgba(230, 162, 28, 0.05));
                backdrop-filter: blur(15px);
                border-radius: 12px;
                box-shadow:
                    0 4px 20px rgba(0, 0, 0, 0.2),
                    0 0 0 1px rgba(250, 182, 51, 0.08),
                    inset 0 1px 0 rgba(255, 255, 255, 0.03);
                margin: 0 auto 20px auto;
                position: relative;
                overflow: hidden;
                opacity: 0;
                transform: translateY(20px);
                animation: tipFadeIn 1.2s ease-out 0.5s forwards, tipBreathe 3s ease-in-out 2s infinite;
                border: 1px solid rgba(250, 182, 51, 0.1);

            }

            .tip-box::before {
                content: '';
                position: absolute;
                top: -1px;
                left: -1px;
                right: -1px;
                bottom: -1px;
                border-radius: 12px;
                z-index: -1;
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .tip-box:hover::before {
                opacity: 1;
            }

            .tip-content {
                display: flex;
                align-items: center;
                gap: 15px;
                color: #cbd5e0;
                font-size: 14px;
                font-weight: 500;
                letter-spacing: 0.3px;
            }

            .tip-icon {
                color: #fab633;
                font-size: 18px;
                filter: drop-shadow(0 0 8px rgba(250, 182, 51, 0.3));
                animation: iconFloat 4s ease-in-out infinite;
                flex-shrink: 0;
            }

            .tip-text {
                transition: all 0.3s ease;
            }

            .tip-box:hover .tip-text {
                color: #e0e0e0;
                text-shadow: 0 0 8px rgba(250, 182, 51, 0.2);
            }

            /* Animations */
            @keyframes tipFadeIn {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes tipBreathe {
                0%, 100% {
                    transform: scale(1);
                    box-shadow:
                        0 4px 20px rgba(0, 0, 0, 0.2),
                        0 0 0 1px rgba(250, 182, 51, 0.08);
                }
                50% {
                    transform: scale(1.01);
                    box-shadow:
                        0 6px 25px rgba(0, 0, 0, 0.25),
                        0 0 0 1px rgba(250, 182, 51, 0.12),
                        0 0 15px rgba(250, 182, 51, 0.1);
                }
            }

            @keyframes iconFloat {
                0%, 100% {
                    transform: translate(0, 0);
                }
                25% {
                    transform: translate(2px, -3px);
                }
                50% {
                    transform: translate(-1px, -2px);
                }
                75% {
                    transform: translate(-2px, 1px);
                }
            }

            /* Responsive adjustments */
            @media (max-width: 768px) {
                .tip-box {
                    margin: 0 20px 20px 20px;
                    padding: 12px 20px;
                }

                .tip-content {
                    font-size: 13px;
                    gap: 12px;
                }

                .tip-icon {
                    font-size: 16px;
                }
            }
    </style>
</head>
<body>

    {% include 'header.html' %}

    <div class="container"><!-- Tip Box -->
        <div style="padding-top: 50px;">
            <div class="tip-box">
                <div class="tip-content">
                    <i class="fas fa-info-circle tip-icon"></i>
                    <span class="tip-text">This is made for International Baccalaureate Programme (IB Diploma), specifically ESS classes. Where you have to spend 1st quarter doing transect sampling through recording of data in spreadsheets and utilizing graphs. However all the data is lost right after the class, thats why I created a common recourse for my school, UWC ISAK Japan</span>
                </div>
            </div>
        </div>

        <!-- Map part -->
        <div id="map"></div>

        {% include 'divider.html' %}

        <!-- Upload and Analysis Section -->
        <div class="upload-analysis-section">
            <!-- Left side: Upload -->
            <div class="upload-side">
                <!-- Warning box for non-logged-in users -->
                {% if not logged_in %}
                <div class="upload-warning card warning-hover" style="background: linear-gradient(135deg, #3498db, #2980b9); border-left: 4px solid #2c3e50; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div class="level" style="margin: 0;">
                        <div class="level-left">
                            <div class="level-item">
                                <i class="fas fa-triangle-exclamation" style="color: #fff; margin-right: 10px; font-size: 18px;"></i>
                                <span style="color: #fff; font-weight: 600;">You need to login first to upload images</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Image upload part -->
                <div class="upload-card card">
                    <h2>Upload Forest Species Images</h2>
                    <div class="drop-zone {% if not logged_in %}disabled{% endif %}" id="dropZone">
                        <button class="btn btn-danger btn--xl {% if not logged_in %}btn-disabled{% else %}btn-upload{% endif %}"
                                {% if not logged_in %}disabled{% endif %}
                                onclick="{% if logged_in %}document.getElementById('fileInput').click(){% endif %}">
                            Select Images
                        </button>
                        <input type="file" id="fileInput" multiple accept="image/*" style="display: none;" {% if not logged_in %}disabled{% endif %}>
                        <p class="text-sm" style="text-decoration: underline; {% if not logged_in %}color: #666;{% endif %}">
                            {% if logged_in %}or drop images here{% else %}Login required to upload{% endif %}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Arrow and Label -->
            <div class="flow-arrow">
                <div class="arrow-label">Analyze Data</div>
                <div class="arrow-icon">
                    <i class="fas fa-arrow-right"></i>
                </div>
            </div>

            <!-- Right side: Analysis -->
            <div class="analyze-side">
                <div class="analyze-container">
                    <button class="btn-analyze" onclick="startAnalysis()">
                        <i class="fas fa-chart-bar"></i>
                        Generate Insights
                    </button>
                    <p class="analyze-description">
                        Create distribution graphs, kite diagrams & statistical analysis
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Progress Modal -->
    <div class="modal-overlay" id="analysisModal">
        <div class="modal-content analysis-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-brain"></i>
                    Analyzing Forest Data
                </h3>
            </div>
            <div class="modal-body">
                <div class="analysis-progress-container">
                    <div class="progress-icon">
                        <i class="fas fa-seedling analysis-icon"></i>
                    </div>
                    <div class="progress-text" id="progressText">Preparing your graphs...</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div class="progress-percentage" id="progressPercentage">0%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Preview Modal -->
    <div class="modal-overlay" id="uploadModal">
        <div class="modal-content">
            <div class="loading-overlay" id="loadingOverlay">
                <div class="loading-spinner"></div>
            </div>
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-images"></i>
                    Prepare Your Images for Upload
                </h3>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Images will be populated here -->
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-cancel" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn-modal btn-upload-modal" id="uploadBtn" onclick="finalUpload()">
                    <i class="fas fa-cloud-upload-alt"></i> Upload All Images
                </button>
            </div>
        </div>
    </div>

    <!-- Location Modal -->
    <div class="modal-overlay" id="locationModal">
        <div class="modal-content location-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-map-marker-alt"></i>
                    Verify Image Location
                </h3>
            </div>
            <div class="modal-body">
                <div class="coordinates-display">
                    <div class="coord-info">
                        <strong>Extracted Coordinates:</strong>
                        <div class="coord-values" id="coordinatesDisplay">
                            Lat: <span id="latDisplay">--</span>, Lng: <span id="lngDisplay">--</span>
                        </div>
                    </div>
                    <button class="btn-location" id="editLocationBtn" onclick="enableLocationEdit()">
                        <i class="fas fa-mouse-pointer"></i> Click Map to Move
                    </button>
                </div>
                <div id="locationMap"></div>
                <div class="location-info" id="locationStatus">
                    <i class="fas fa-info-circle"></i>
                    <span id="locationStatusText">Location extracted from image metadata.</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-cancel" onclick="closeLocationModal()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="btn-modal btn-upload-modal" onclick="saveLocation()">
                    <i class="fas fa-check"></i> Confirm Location
                </button>
            </div>
        </div>
    </div>

    {% include 'footer.html' %}

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const isLoggedIn = {{ 'true' if logged_in else 'false' }};
        let selectedFiles = [];
        let currentImageIndex = 0;
        let locationMap = null;
        let locationMarker = null;
        let isEditingLocation = false;

        // Predefined species types and icons
        const speciesTypes = ['Tree', 'Flower', 'Shrub', 'Moss', 'Grass', 'Mushroom', 'Other'];
        const predefinedIcons = [
            { class: 'fa-tree', name: 'Tree' },
            { class: 'fa-seedling', name: 'Seedling' },
            { class: 'fa-leaf', name: 'Leaf' },
            { class: 'fa-clover', name: 'Clover' },
            { class: 'fa-spa', name: 'Plant' }
        ];

        // Forest bounds (same as main map)
        const forestBounds = {
            north: 36.362861,
            south: 36.355673,
            east: 138.554646,
            west: 138.548037
        };

        // Only add event listeners if logged in
        if (isLoggedIn) {
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                handleFiles(files);
            });

            fileInput.addEventListener('change', () => {
                const files = fileInput.files;
                handleFiles(files);
            });
        } else {
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                alert('Please log in to upload images');
                window.location.href = '/login/';
            });
        }

        function handleFiles(files) {
            if (!isLoggedIn) {
                alert('Please log in to upload images');
                window.location.href = '/login/';
                return;
            }

            if (files.length > 0) {
                selectedFiles = Array.from(files);
                processImages();
            }
        }

        async function processImages() {
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = '';
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('uploadModal').style.display = 'flex';

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const imagePreview = await createImagePreview(file, i);
                modalBody.appendChild(imagePreview);
            }

            document.getElementById('loadingOverlay').style.display = 'none';
        }

        async function createImagePreview(file, index) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const container = document.createElement('div');
                    container.className = 'image-preview-item';

                    // Extract EXIF data
                    const coords = await extractCoordinates(file);
                    const locationStatus = getLocationStatus(coords);

                    container.innerHTML = `
                        <div class="image-preview-content">
                            <img src="${e.target.result}" alt="Preview" class="image-preview">
                            <div class="image-form-fields">
                                <div class="form-group">
                                    <label class="form-label">Species Name</label>
                                    <input type="text" class="form-input" id="speciesName_${index}"
                                           placeholder="Enter species name...">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Species Type</label>
                                    <select class="form-select" id="speciesType_${index}">
                                        <option value="">Select type...</option>
                                        ${speciesTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Choose Icon</label>
                                    <div class="icon-grid" id="iconGrid_${index}">
                                        ${predefinedIcons.map(icon => `
                                            <div class="icon-option" data-icon="${icon.class}" onclick="selectIcon(${index}, '${icon.class}')">
                                                <i class="fas ${icon.class}"></i>
                                                <span>${icon.name}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="location-info ${locationStatus.warning ? 'location-warning' : ''}">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${locationStatus.title}</strong>
                                            <div style="font-size: 12px; margin-top: 5px;" class="location-message">
                                                ${locationStatus.message}
                                            </div>
                                        </div>
                                        <div>
                                            <button class="btn-location" onclick="openLocationModal(${index})">
                                                <i class="fas fa-map-marker-alt"></i> Edit Location
                                            </button>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    `;

                    // Store coordinates in the element
                    container.dataset.latitude = coords.lat || '';
                    container.dataset.longitude = coords.lng || '';
                    container.dataset.filename = file.name;

                    resolve(container);
                };
                reader.readAsDataURL(file);
            });
        }

        async function extractCoordinates(file) {
            return new Promise((resolve) => {
                if (typeof EXIF !== 'undefined') {
                    EXIF.getData(file, function() {
                        const lat = EXIF.getTag(this, "GPSLatitude");
                        const lon = EXIF.getTag(this, "GPSLongitude");
                        const latRef = EXIF.getTag(this, "GPSLatitudeRef");
                        const lonRef = EXIF.getTag(this, "GPSLongitudeRef");

                        if (lat && lon && latRef && lonRef) {
                            const latitude = convertDMSToDD(lat, latRef);
                            const longitude = convertDMSToDD(lon, lonRef);
                            resolve({ lat: latitude, lng: longitude });
                        } else {
                            resolve({ lat: null, lng: null });
                        }
                    });
                } else {
                    // Fallback: simulate coordinates for demo
                    const hasGPS = Math.random() > 0.3; // 70% chance of having GPS data

                    if (!hasGPS) {
                        resolve({ lat: null, lng: null });
                        return;
                    }

                    const lat = forestBounds.south + Math.random() * (forestBounds.north - forestBounds.south);
                    const lng = forestBounds.west + Math.random() * (forestBounds.east - forestBounds.west);

                    // Simulate some images being outside bounds
                    const isOutside = Math.random() > 0.8; // 20% chance of being outside
                    if (isOutside) {
                        resolve({
                            lat: lat + (Math.random() - 0.5) * 0.01,
                            lng: lng + (Math.random() - 0.5) * 0.01
                        });
                    } else {
                        resolve({ lat, lng });
                    }
                }
            });
        }

        function convertDMSToDD(dms, ref) {
            let dd = dms[0] + dms[1]/60 + dms[2]/3600;
            if (ref === "S" || ref === "W") dd = dd * -1;
            return dd;
        }

        function getLocationStatus(coords) {
            if (!coords.lat || !coords.lng) {
                return {
                    title: 'No Location Found',
                    message: 'Please specify location on the map',
                    warning: true
                };
            }

            const isInBounds = coords.lat >= forestBounds.south &&
                              coords.lat <= forestBounds.north &&
                              coords.lng >= forestBounds.west &&
                              coords.lng <= forestBounds.east;

            if (!isInBounds) {
                return {
                    title: 'Location Outside Forest Area',
                    message: 'Please edit the location to place it within the forest boundaries',
                    warning: true
                };
            }

            return {
                title: 'Location Found',
                message: `Lat: ${coords.lat.toFixed(6)}, Lng: ${coords.lng.toFixed(6)}`,
                warning: false
            };
        }

        function selectIcon(imageIndex, iconClass) {
            const iconGrid = document.getElementById(`iconGrid_${imageIndex}`);
            iconGrid.querySelectorAll('.icon-option').forEach(option => {
                option.classList.remove('selected');
            });

            iconGrid.querySelector(`[data-icon="${iconClass}"]`).classList.add('selected');
        }

        function openLocationModal(imageIndex) {
            currentImageIndex = imageIndex;
            const container = document.querySelector(`.image-preview-item:nth-child(${imageIndex + 1})`);
            const lat = parseFloat(container.dataset.latitude) || 36.359385;
            const lng = parseFloat(container.dataset.longitude) || 36.551357;

            document.getElementById('latDisplay').textContent = lat.toFixed(6);
            document.getElementById('lngDisplay').textContent = lng.toFixed(6);

            document.getElementById('locationModal').style.display = 'flex';

            // Initialize map after a short delay to ensure modal is visible
            setTimeout(() => {
                initLocationMap(lat, lng);
            }, 100);
        }

        function initLocationMap(lat, lng) {
            if (locationMap) {
                locationMap.remove();
            }

            locationMap = L.map('locationMap', {
                maxBounds: [[forestBounds.south, forestBounds.west], [forestBounds.north, forestBounds.east]],
                maxBoundsViscosity: 1.0,
                minZoom: 16
            });

            locationMap.setView([lat, lng], 17);

            // Add tile layer
            L.tileLayer('https://tile.thunderforest.com/cycle/{z}/{x}/{y}.png?apikey=21fdb708eba34156883a34e3348bcb6e', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(locationMap);

            // Add forest boundary
            const latlngs = [[36.355673, 138.551822], [36.360569, 138.548037], [36.36286106538286, 138.55092177935643], [36.35843935596947, 138.55464579115937]];
            L.polygon(latlngs, {color: '#fab633', weight: 3, opacity: 0.9, fill: false}).addTo(locationMap);

            // Add marker
            const selectedIcon = document.querySelector(`#iconGrid_${currentImageIndex} .icon-option.selected`);
            const iconClass = selectedIcon ? selectedIcon.dataset.icon : 'fa-map-marker-alt';

            locationMarker = L.marker([lat, lng], {
                draggable: false,
                icon: createCustomIcon(iconClass)
            }).addTo(locationMap);

            // Add click event to move marker
            locationMap.on('click', function(e) {
                const newLat = e.latlng.lat;
                const newLng = e.latlng.lng;

                // Move marker to clicked position
                locationMarker.setLatLng([newLat, newLng]);

                // Update coordinates display
                document.getElementById('latDisplay').textContent = newLat.toFixed(6);
                document.getElementById('lngDisplay').textContent = newLng.toFixed(6);

                // Update status
                updateLocationStatus(newLat, newLng);
            });

            updateLocationStatus(lat, lng);
        }

        function createCustomIcon(iconClass) {
            return L.divIcon({
                html: `<i class="fas ${iconClass}" style="color: #fab633; font-size: 24px;"></i>`,
                iconSize: [30, 30],
                className: 'custom-marker'
            });
        }

        function enableLocationEdit() {
            // This function is no longer needed since we use click-to-move
            // But keeping it for the button functionality
            alert('Click anywhere on the map to move the marker to that location!');
        }

        function savePosition() {
            // This function is no longer needed since we use click-to-move
            // But keeping it for consistency
        }

        function updateLocationStatus(lat, lng) {
            const isInBounds = lat >= forestBounds.south &&
                              lat <= forestBounds.north &&
                              lng >= forestBounds.west &&
                              lng <= forestBounds.east;

            const statusElement = document.getElementById('locationStatus');
            const statusText = document.getElementById('locationStatusText');

            if (isInBounds) {
                statusElement.className = 'location-info';
                statusText.innerHTML = '<i class="fas fa-check-circle"></i> Location is within forest boundaries.';
            } else {
                statusElement.className = 'location-info location-warning';
                statusText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Warning: Location is outside forest area.';
            }
        }

        function saveLocation() {
            if (locationMarker) {
                const position = locationMarker.getLatLng();
                const container = document.querySelector(`.image-preview-item:nth-child(${currentImageIndex + 1})`);
                container.dataset.latitude = position.lat;
                container.dataset.longitude = position.lng;

                // Update the location status in the main modal with the same message format
                const coords = { lat: position.lat, lng: position.lng };
                const locationStatus = getLocationStatus(coords);
                const locationInfo = container.querySelector('.location-info');

                // Update the warning class
                locationInfo.className = `location-info ${locationStatus.warning ? 'location-warning' : ''}`;

                // Update the title and message in the first modal
                const titleElement = locationInfo.querySelector('div strong');
                const messageElement = locationInfo.querySelector('.location-message');

                titleElement.textContent = locationStatus.title;
                messageElement.textContent = locationStatus.message;

            }

            closeLocationModal();
        }

        function closeLocationModal() {
            document.getElementById('locationModal').style.display = 'none';
            if (locationMap) {
                locationMap.remove();
                locationMap = null;
            }
        }

        function closeModal() {
            document.getElementById('uploadModal').style.display = 'none';
            selectedFiles = [];
            document.getElementById('fileInput').value = '';
        }

        async function finalUpload() {
            const imageData = [];

            for (let i = 0; i < selectedFiles.length; i++) {
                const container = document.querySelector(`.image-preview-item:nth-child(${i + 1})`);
                const speciesName = document.getElementById(`speciesName_${i}`).value;
                const speciesType = document.getElementById(`speciesType_${i}`).value;
                const selectedIcon = container.querySelector('.icon-option.selected');

                if (!speciesName || !speciesType || !selectedIcon) {
                    alert(`Please complete all fields for image ${i + 1}`);
                    return;
                }

                imageData.push({
                    filename: container.dataset.filename,
                    species_name: speciesName,
                    species_type: speciesType,
                    icon_class: selectedIcon.dataset.icon,
                    latitude: parseFloat(container.dataset.latitude) || null,
                    longitude: parseFloat(container.dataset.longitude) || null
                });
            }

            // Show loading and disable button
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('uploadBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

            // Upload to server
            const formData = new FormData();
            selectedFiles.forEach(file => formData.append('files', file));
            formData.append('images', JSON.stringify(imageData));

            try {
                const response = await fetch('/upload/', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Upload failed');
                }

                const result = await response.json();
                alert(`Successfully uploaded ${result.uploaded.length} images!`);

                if (result.failed && result.failed.length > 0) {
                    console.warn('Some files failed to upload:', result.failed);
                }

                closeModal();

                // Reload the page to show new markers
                window.location.reload();

            } catch (error) {
                console.error('Upload error:', error);
                alert('Error uploading images. Please try again.');
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('uploadBtn').innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload All Images';
            }
        }
    </script>

    <!-- Map initialization script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var map = L.map('map', {
                maxBounds: [[36.355673, 138.548037], [36.362861, 138.554646]],
                maxBoundsViscosity: 1.0,
                minZoom: 16
            });
            map.setView([36.359385, 138.551357], 16);

            var latlngs = [[36.355673, 138.551822], [36.360569, 138.548037], [36.36286106538286, 138.55092177935643], [36.35843935596947, 138.55464579115937]];
            var polygon = L.polygon(latlngs, {color: '#fab633', smoothFactor: 1, noClip: true, weight: 3, opacity: 0.9, fill: false}).addTo(map);
            map.fitBounds(polygon.getBounds());

            // add hover popup
            polygon.on('mouseover', function(e) {
                var popup = L.popup({
                    autoPan: true,
                    autoPanPadding: [10, 10],
                    keepInView: true,
                    closeButton: false,
                    autoClose: true,
                    maxWidth: 150
                })
                    .setLatLng(e.latlng) // for hover
                    .setContent('XXXX Forest')
                    .openOn(map);
            });
            polygon.on('mouseout', function() {
                map.closePopup(); // close popup
            });

            L.tileLayer('https://tile.thunderforest.com/cycle/{z}/{x}/{y}.png?apikey=21fdb708eba34156883a34e3348bcb6e', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            //http://philliplemons.com/posts/ray-casting-algorithm function to check if a point is inside a polygon (ray-casting)
            function isPointInPolygon(point, vertices) {
                var x = point[0], y = point[1];
                var inside = false;
                for (var i = 0, j = vertices.length - 1; i < vertices.length; j = i++) {
                    var xi = vertices[i][0], yi = vertices[i][1];
                    var xj = vertices[j][0], yj = vertices[j][1];
                    var intersect = ((yi > y) !== (yj > y)) &&
                        (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                    if (intersect) inside = !inside;
                }
                return inside;
            }

            var topLeft = [36.360569, 138.548037]; // P1
            var topRight = [36.36286106538286, 138.55092177935643]; // P2
            var bottomLeft = [36.355673, 138.551822]; // P0
            var bottomRight = [36.35843935596947, 138.55464579115937]; // P3

            var vDivisions = 6;
            var hDivisions = 11;

            var quadrantLayer = L.layerGroup();

            //display images on the map
            fetch('/get_images/')
               .then(response => response.json())
               .then(data => {

                   var images = data || [];
                   var markers = L.markerClusterGroup();

                   for (var i = 0; i < vDivisions; i++) {
                       for (var j = 0; j < hDivisions; j++) {
                           // calculate fractions for interpolation
                           var vFraction1 = i / vDivisions;
                           var vFraction2 = (i + 1) / vDivisions;
                           var hFraction1 = j / hDivisions;
                           var hFraction2 = (j + 1) / hDivisions;

                           // interpolate points for quadrilateral vertices
                           var tlTopLat = topLeft[0] + vFraction1 * (topRight[0] - topLeft[0]);
                           var tlTopLng = topLeft[1] + vFraction1 * (topRight[1] - topLeft[1]);
                           var tlBottomLat = bottomLeft[0] + vFraction1 * (bottomRight[0] - bottomLeft[0]);
                           var tlBottomLng = bottomLeft[1] + vFraction1 * (bottomRight[1] - bottomLeft[1]);
                           var topLeftVertex = [
                               tlTopLat + hFraction1 * (tlBottomLat - tlTopLat),
                               tlTopLng + hFraction1 * (tlBottomLng - tlTopLng)
                           ];

                           // Top-right vertex
                           var trTopLat = topLeft[0] + vFraction2 * (topRight[0] - topLeft[0]);
                           var trTopLng = topLeft[1] + vFraction2 * (topRight[1] - topLeft[1]);
                           var trBottomLat = bottomLeft[0] + vFraction2 * (bottomRight[0] - bottomLeft[0]);
                           var trBottomLng = bottomLeft[1] + vFraction2 * (bottomRight[1] - bottomLeft[1]);
                           var topRightVertex = [
                               trTopLat + hFraction1 * (trBottomLat - trTopLat),
                               trTopLng + hFraction1 * (trBottomLng - trTopLng)
                           ];

                           // Bottom-right vertex
                           var bottomRightVertex = [
                               trTopLat + hFraction2 * (trBottomLat - trTopLat),
                               trTopLng + hFraction2 * (trBottomLng - trTopLng)
                           ];

                           // Bottom-left vertex
                           var bottomLeftVertex = [
                               tlTopLat + hFraction2 * (tlBottomLat - tlTopLat),
                               tlTopLng + hFraction2 * (tlBottomLng - tlTopLng)
                           ];

                           var vertices = [
                                       topLeftVertex,
                                       topRightVertex,
                                       bottomRightVertex,
                                       bottomLeftVertex
                                   ];

                           var speciesCount = 0;
                           images.forEach(image => {
                               if (isPointInPolygon([image.latitude, image.longitude], vertices)) {
                                   speciesCount++;
                               }
                           });

                           // Define quadrilateral
                           var quad = L.polygon(vertices, {
                               color: '#fab633', // Orange border
                               weight: 1,
                               opacity: 0.9,
                               fillColor: '#70df7e', // Blue fill
                               fillOpacity: 0.4
                           });

                           quad.bindPopup(`
                               <p class='text-sm font-bold'>Species Count: ${speciesCount}</p>
                               <p class='text-xs'>Quadrant ${i + 1},${j + 1}</p>`,
                               {
                               closeButton: false,
                               autoClose: false,
                               closeOnClick: false,
                               autoPan: true,
                               autoPanPadding: [10, 10],
                               keepInView: true,
                               maxWidth: 200,
                               className: 'quadrant-popup'
                           });

                           // Use closure to capture vertices for each quadrilateral
                           (function(tlVertex, trVertex, brVertex, blVertex) {
                               quad.on('mouseover', function(e) {
                                   // Calculate centroid for popup position
                                   var latSum = (tlVertex[0] + trVertex[0] + brVertex[0] + blVertex[0]) / 4;
                                   var lngSum = (tlVertex[1] + trVertex[1] + brVertex[1] + blVertex[1]) / 4;
                                   this.openPopup([latSum, lngSum]);
                               });
                               quad.on('mouseout', function() {
                                   this.closePopup();
                               });
                           })(topLeftVertex, topRightVertex, bottomRightVertex, bottomLeftVertex);

                           quadrantLayer.addLayer(quad);
                       }
                   }

                   // Add markers with custom icons
                   data.forEach(image => {
                       const iconClass = image.icon_class || 'fa-map-marker-alt';
                       const customIcon = L.divIcon({
                           html: `<i class="fas ${iconClass}" style="color: #fab633; font-size: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);"></i>`,
                           iconSize: [25, 25],
                           className: 'custom-marker'
                       });

                       var marker = L.marker([image.latitude, image.longitude], { icon: customIcon })
                           .bindPopup(`
                               <img class='img-stretch' src="/static/uploads/${image.filename}" style='height: 200px; width: 300px; border-radius: 5px;'>
                               <p class='text-xs'><strong>${image.species_name || 'Unknown Species'}</strong></p>
                               <p class='text-xs'>Type: ${image.species_type || 'Unknown'}</p>
                               <p class='text-xs'>Uploaded by: ${image.username} <br />Upload date: ${image.upload_date}</p>
                           `, {
                               maxWidth: 320,
                               minWidth: 300,
                               maxHeight: 400,
                               autoPan: true,
                               autoPanPadding: [20, 20],
                               keepInView: true,
                               closeButton: true,
                               autoClose: false,
                               className: 'custom-popup'
                           });
                       markers.addLayer(marker);
                   });
                   map.addLayer(markers);

                   // Add layer control
                   var overlayLayers = {
                       "Quadrant Sampling": quadrantLayer
                   };
                   L.control.layers(null, overlayLayers, { collapsed: false }).addTo(map);
               });
        });

        function startAnalysis() {
            document.getElementById('analysisModal').style.display = 'flex';

            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressPercentage = document.getElementById('progressPercentage');

            let progress = 0;
            const totalDuration = 4000; // 4 seconds
            const interval = 50; // Update every 50ms
            const increment = (100 / (totalDuration / interval));

            // Start with first message
            progressText.textContent = "Preparing your graphs...";

            const progressInterval = setInterval(() => {
                progress += increment;

                if (progress >= 100) {
                    progress = 100;
                    clearInterval(progressInterval);

                    // Final message and redirect
                    progressText.textContent = "Analysis complete!";
                    progressPercentage.textContent = "100%";
                    progressBar.style.width = "100%";

                    setTimeout(() => {
                        window.location.href = '/output/';
                    }, 800);
                } else {
                    // Change message halfway through
                    if (progress >= 50 && progressText.textContent === "Preparing your graphs...") {
                        progressText.textContent = "Doing transect sampling...";
                    }

                    progressPercentage.textContent = Math.round(progress) + '%';
                    progressBar.style.width = progress + '%';
                }
            }, interval);
        }
    </script>
</body>
</html>